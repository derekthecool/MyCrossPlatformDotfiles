# These tests are meant to create a pcap file since saving a pcap in git repository is not great (git lfs)
# Storing the pcap bytes in text works better and is more portable
BeforeAll {
    Import-Module $PSScriptRoot/../*.psd1
    $pcap_file = "$([IO.Path]::GetTempFileName()).pcap"
    [IO.File]::WriteAllBytes($pcap_file, [Convert]::FromBase64String('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'))
}

AfterAll {
    Remove-Item $pcap_file
}

Describe 'Pcap processing tests' -Skip:([bool](!(Get-Command tshark -ErrorAction SilentlyContinue))) {
    It 'Get-PcapSummary' {
        Get-PcapSummary -Path $pcap_file | Should -Not -BeNullOrEmpty
    }

    It 'Get-PcapSummary protocols' {
        Get-PcapSummary -Path $pcap_file |
            Select-Object -ExpandProperty Protocols |
            Should -Contain MQTT
    }

    It 'Get-PcapSummary calculated SHA256 matches result from Get-FileHash' {
        $getFileHashResult = Get-FileHash -Algorithm SHA256 $pcap_file | Select-Object -ExpandProperty Hash
        Get-PcapSummary -Path $pcap_file |
            Select-Object -ExpandProperty SHA256 |
            Should -Match $getFileHashResult
    }

    It 'Get-PcapSummary should have exact number of packets' {
        $pcap_file |
            Get-PcapSummary |
            Select-Object -ExpandProperty 'Number of packets' |
            Should -BeExactly 29
    }
}
