name: Run Pester Tests on Linux

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: Pester Test Runner on ${{ matrix.container }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container:
          - debian:bullseye
          - fedora:latest
          - archlinux:latest
          - nixos/nix:latest
    container:
      image: ${{ matrix.container }}

    steps:
      - name: Install Node.js for NixOS
        if: contains(matrix.container, 'nixos/nix')
        run: |
          nix-env -iA nixpkgs.nodejs-18_x

      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Install and Setup PowerShell and Pester
        run: |
          case ${{ matrix.container }} in
            debian*)
              apt-get update && apt-get install -y wget apt-transport-https git software-properties-common
              wget -q "https://packages.microsoft.com/config/debian/$(. /etc/os-release && echo $VERSION_ID)/packages-microsoft-prod.deb"
              dpkg -i packages-microsoft-prod.deb
              apt-get update && apt-get install -y powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            fedora*)
              dnf install -y 'dnf-command(config-manager)'
              dnf config-manager --add-repo https://packages.microsoft.com/fedora/$(. /etc/os-release && echo $VERSION_ID)/prod
              dnf install -y powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            archlinux*)
              pacman -Sy --noconfirm wget git base-devel
              echo -e "builduser\nbuilduser\n" | adduser builduser
              printf 'builduser ALL=(ALL) NOPASSWD: ALL\n' | tee -a /etc/sudoers
              sudo -u builduser sh -c "cd; git clone https://aur.archlinux.org/yay.git; cd yay; makepkg -si --noconfirm"
              sudo -u builduser yay -S --noconfirm powershell
              sudo -u builduser pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            nixos/nix*)
              nix-env -iA nixpkgs.powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
          esac

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Invoke-Pester -Path './Scripts/Tests' -Passthru -Output Detailed
