name: Run Pester Tests on Linux

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: Pester Test Runner on ${{ matrix.container }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container:
          - debian:bullseye
          - fedora:latest
          - archlinux:latest
          - nixos/nix:latest
    container:
      image: ${{ matrix.container }}

    steps:
      - name: Install Node.js for NixOS
        if: contains(matrix.container, 'nixos/nix')
        run: |
          nix-env -iA nixpkgs.nodejs-16_x

      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Install and Setup PowerShell and Pester
        run: |
          case ${{ matrix.container }} in
            debian*)
              apt-get update && apt-get install -y wget apt-transport-https git software-properties-common
              wget -q "https://packages.microsoft.com/config/debian/$(. /etc/os-release && echo $VERSION_ID)/packages-microsoft-prod.deb"
              dpkg -i packages-microsoft-prod.deb
              apt-get update && apt-get install -y powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            fedora*)
              dnf install -y wget git
              rpm --import https://packages.microsoft.com/keys/microsoft.asc
              dnf config-manager --add-repo https://packages.microsoft.com/fedora/$(. /etc/os-release && echo $VERSION_ID)/prod
              dnf install -y powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            archlinux*)
              pacman -Sy --noconfirm wget git base-devel
              git clone https://aur.archlinux.org/yay.git
              cd yay
              makepkg -si --noconfirm
              yay -Sy --noconfirm powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
            nixos/nix*)
              nix-env -iA nixpkgs.powershell
              pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck"
              ;;
          esac

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Invoke-Pester -Path './Scripts/Tests' -Passthru -Output Detailed
